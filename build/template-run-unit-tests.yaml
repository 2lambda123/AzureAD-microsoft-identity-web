# template-run-unit-tests.yaml
# Run all unit tests across the IdWeb project

steps:

- task: VSTest@2
  displayName: 'Run integration tests (.NET 8)'
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: 'Tests\**\WebAppUiTests\**\net8.0\WebAppUiTests.dll'
    searchFolder: '$(System.DefaultWorkingDirectory)'
    rerunFailedTests: true
    rerunMaxAttempts: '3'
    runInParallel: false
    codeCoverageEnabled: true
    failOnMinTestsNotRun: false
    minimumExpectedTests: '1'
  continueOnError: true
    
- task: PublishBuildArtifacts@1
  displayName: 'Publish traces after test'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E Tests/PlaywrightTraces/'
    ArtifactName: 'traces-after-tests-$(Build.BuildNumber)'
  condition: failed()

- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    projects: |
        Tests/**/*.csproj
        !Tests/DevApps/**/*.csproj
        !Tests/**/WebAppUiTests.csproj
    arguments: '--collect "Code coverage" --settings "build\CodeCoverage.runsettings"'
  continueOnError: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish traces after test'
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/tests/E2E Tests/PlaywrightTraces/'
    ArtifactName: 'traces-after-tests-$(Build.BuildNumber)'
  condition: failed()